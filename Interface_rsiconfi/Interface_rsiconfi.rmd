---
title: "Interface com RSiconfi"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(rsiconfi)
library(networkD3)
library(ggplot2)
library(viridis)
library(readr)
library(dplyr)
library(shinyjs)
library(kableExtra)
library(purrr)



#state_machine<<-1

glossario_siconfi <- read_delim("glossario_siconfi.csv", 
     ";", escape_double = FALSE, trim_ws = TRUE)

instrucoes <- read_delim("instrucoes.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE)

state_element <- read_delim("state_element.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE)

state_button_next <- read_delim("state_button_next.csv", 
    ";", escape_double = FALSE, col_types = cols(X4 = col_skip()), 
    trim_ws = TRUE)

set_next_state<- function(current_state,a_button){
  
  
  
  #hide the element associated with the current state
  element<-
    (state_element %>%
    filter(state==current_state)%>%
    select(element))$element
  
  
  
  hide(element)
  
  
  
  #identify the next state
  
  special_state<- FALSE
  
  full_state<-
  state_button_next %>%
    filter(state == current_state,
           button == a_button)
  
  
  
  # full_state<-
  # (state_button_next %>%
  #   filter(state == 2,
  #          button == "A") %>%
  #   select(next_state))$next_state
  
  
  
  if(NROW(full_state)>0){
    condition<- eval(parse(text=full_state$condition[1]))
    if (condition){
      next_state_f <- full_state$next_state
      special_state <- TRUE
    }
    
  }
  
  
  if (!special_state  && a_button == "P"){
    
    
    next_state_f<- as.numeric(current_state) +1
  }

  if (!special_state && a_button == "A"){
    next_state_f<- as.numeric(current_state) - 1
    
  }
  
  
  
  #show the elements and buttons associated with the next state
  df_state_element<-
    state_element %>%
    filter(state==next_state_f)
  
  
  # df_state_element<-
  #   state_element %>%
  #   filter(state==2)
  
  
  element<- df_state_element$element
  button_a<- df_state_element$button_a
  button_p<- df_state_element$button_p
  button_f<- df_state_element$button_f
  
  print(df_state_element)
  
  print(next_state_f)
  promise_state<- 
    state_button_next %>%
    filter(state == next_state_f)
  
  if (NROW(promise_state)>0){
    print(promise_state$condition[1])
    condition<- eval(parse(text=promise_state$condition[1]))
    print(condition)
    if(condition){
     button_p<-1 
    }
  }
  
  #if(special_state){button_p<-1}

  updateTextInput(session = session, inputId = "state", value = next_state_f)
  
  show(element)
  
  if(button_a==1){
    show("anterior")
  } else{
    hide("anterior")
  }
  
  if (button_p==1){
    show("proximo")
  } else{
    hide("proximo")
  }
    
  
  
  if (button_f==1){
    show("finalizar")
  } else{
    hide("finalizar")
  }
  


}

generate_graph<- function(opcao){
  
  
  if (opcao$topico==1){#Receitas orçamentárias
    #df_rec <- rsiconfi::get_dca(c(2015,2018),"I-C","1")
    df_rec <- rsiconfi::get_dca(opcao$ano,"I-C","1")

    df_rec_trabalho<-
      df_rec %>%
      #filter(stringr::str_starts(cod_conta,"R")) %>%
      filter(coluna == "Receitas Brutas Realizadas") %>%
      mutate(nivel_0 = cod_conta =="TotalReceitas" ) %>%
      mutate(nivel_1= (stringr::str_ends(cod_conta,".0.0.0.00.0.0"))) %>%
      mutate(nivel_2= ((stringr::str_sub(cod_conta,5,5)!= "0") & (stringr::str_ends(cod_conta,"0.0.00.0.0")))) %>%
      mutate(nivel_3= ((stringr::str_sub(cod_conta,7,7)!= "0") & (stringr::str_ends(cod_conta,"0.00.0.0")))) %>%
      filter(nivel_0 | nivel_1 | nivel_2 | nivel_3) %>%
      mutate(pai = case_when(
        nivel_1 ~ "TotalReceitas",
        nivel_2 ~ paste0(stringr::str_sub(cod_conta,1,3), ".0.0.0.00.0.0"),
        nivel_3 ~ paste0(stringr::str_sub(cod_conta,1,5), ".0.0.00.0.0")
      )) %>%
      mutate (source = row_number() -1)
    

    
    graph<-
      df_rec_trabalho%>%
      filter(nivel_2==1)%>%
      mutate(conta =  stringr::str_sub(conta, 18,str_length(conta)),
             exercicio = as.character(exercicio))%>%
      select(conta, valor, exercicio) %>%
      mutate(conta = reorder(conta, valor)) %>%
      ggplot(aes(x=conta, y= valor/10^6)) +
      geom_col(fill= "#fdd500") + #
      theme_light() +
      theme(
        #strip.text =  element_blank(),
        axis.text.x =  element_text(angle = 90, hjust = 1),
        panel.grid = element_blank()  )+
      labs(
        y = "Valor em R$ milhões",
        x=  NULL,
        fill = ""  )+
      scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))+
      facet_wrap(factor(exercicio)~.) +
      #facet_grid(unique(conta)+exercicio~., scales =   "free_y")+
      coord_flip()
    
    return(graph)
    
    
  }
  
  if (opcao$topico==2){ #Despesas orçamntárias
    #Criar gráfico de sankey
    df_desp <- rsiconfi::get_dca(opcao$ano,"I-D","1")
    df_desp <-
    df_desp%>%
      filter(coluna %in% opcao$fase)
    #df_desp <- rsiconfi::get_dca(c(2017,2018),"I-D","1")
    
    
    df_desp_trabalho<-
      df_desp %>%
      #filter(stringr::str_starts(cod_conta,"R")) %>%
      #filter(coluna == "Despesas Liquidadas") %>%
      mutate(nivel_0 = cod_conta =="TotalDespesas" ) %>%
      mutate(nivel_1= (stringr::str_ends(cod_conta,"0.00.00.00.00"))) %>%
      mutate(nivel_2= ((stringr::str_sub(cod_conta,5,5)!= "0") & (stringr::str_ends(cod_conta,"00.00.00.00")))) %>%
      mutate(nivel_3= ((stringr::str_sub(cod_conta,7,8)!= "00") & (stringr::str_ends(cod_conta,"00.00.00")))) %>%
      filter(nivel_0 | nivel_1 | nivel_2 | nivel_3  ) %>% #
      mutate(pai = case_when(
        nivel_1 ~ "TotalDespesas",
        nivel_2 ~ paste0(stringr::str_sub(cod_conta,1,3), ".0.00.00.00.00"),
        nivel_3 ~ paste0(stringr::str_sub(cod_conta,1,5), ".00.00.00.00")
      )) %>%
      filter(str_sub(cod_conta,1,2)!="DI")%>%
      mutate (source = row_number() -1)%>% 
      mutate(conta= case_when(
        cod_conta == "TotalDespesas" ~ "Total de despesas liquidadas",
        exercicio == "2018" ~ stringr::str_sub(conta, 16,str_length(conta)),
        exercicio < "2018" ~  stringr::str_sub(conta, 19,str_length(conta))
      ))
    
    
    graph<-
      df_desp_trabalho%>%
      filter(nivel_2==1)%>%
      mutate( exercicio = as.character(exercicio))%>%
      mutate(fase_despesa = coluna) %>%
      select(conta, valor,exercicio,fase_despesa) %>%
      mutate(conta = reorder(conta, valor)) %>%
      ggplot(aes(x=conta, y= valor/10^6, fill=fase_despesa)) + #,
      geom_col( )+ #fill= "#329c2d"
      theme_light() +
      theme(
        #strip.text =  element_blank(),
        axis.text.x =  element_text(angle = 90, hjust = 1),
        panel.grid = element_blank()  )+
      labs(
        y = "Valor em R$ milhões",
        x=  NULL,
        fill = ""  )+
      scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))+
      scale_fill_viridis(discrete = TRUE)+
      facet_wrap(factor(exercicio)~.) +
      coord_flip()
    
    return(graph)
    
  }
  
}

generate_dt <- function(opcao){
  if (opcao$topico ==1){
    df_rec <- rsiconfi::get_dca(opcao$ano,"I-C","1")
    return(df_rec)
  }
  
  if (opcao$topico ==2){
    df_desp <- rsiconfi::get_dca(opcao$ano,"I-D","1")
    df_desp <-
    df_desp%>%
      filter(coluna %in% opcao$fase)

    return(df_desp)
  }
  
}

generate_script<- function(opcao){
  
  lines_script<- tibble(script="" )
  
  lines_script[1,1]<- '# install.packages("devtools")'
  lines_script[2,1]<- 'devtools::install_github("tchiluanda/rsiconfi")' 
  lines_script[3,1]<- "#get data using rsiconfi which is the package that consues SICONFI API"
  
  lista_ano<- opcao$ano[1]
  
  for (ano in opcao$ano[-1]){
    lista_ano<- paste(lista_ano,ano,sep = ",")
  }

  if (opcao$topico ==1){
    
    lines_script[4,1]<- paste0("df_rec <- rsiconfi::get_dca(c(",lista_ano,"),'I-C','1')")
    
  }
  
  if (opcao$topico ==2){
    
    lista_fase<- paste0("'",opcao$fase[1], "'")
    for (fase in opcao$fase[-1]){
      lista_fase<- paste0(lista_fase,",","'", fase, "'")
    }

    
    lines_script[4,1]<- paste0("df_desp <- rsiconfi::get_dca(c(",lista_ano,"),'I-D','1')")
    lines_script[5,1]<- "#Filter the data. Only the selected expenditure phases will be available"
    lines_script[6,1]<- paste0("df_desp <-df_desp%>%filter(coluna %in% c(",lista_fase,"))")
    
  }

  
  lines_script

  
}

```

Inputs {.sidebar}
-------------------------------------

```{r}
radioButtons("topico",label = "Escolha o tipo de consulta", choices = unique(glossario_siconfi%>%
  select(topico))$topico, selected = (glossario_siconfi%>%
  select(topico))$topico[1])

useShinyjs(rmd = TRUE)

hidden(
         div(id = "ano", selectInput("ano", label ="Informe o ano", choices = 2018:2014, selected = 2018, multiple = TRUE)))

hidden(
  div(id = "periodicidade", radioButtons("periodicidade", label ="Informe a periodicidade", choices = c("Bimestral","Quadrimestral","Semestral", "Anual"), selected = "Anual"))
  
         )

hidden(
  div(id = "fase", checkboxGroupInput("fase", label ="Informe a fase da despesa", choices = c("Despesas Empenhadas", "Despesas Liquidadas","Despesas Pagas"), selected = "Despesas Liquidadas"))
  
         )


hidden( div(id = "finalizar",actionButton("finalizar", "Finalizar")))

hidden(
         div(id = "state", textInput("state", "estado", value = "1", width = NULL,
   placeholder = NULL)))

hidden(
         div(id = "anterior", actionButton("anterior", "Anterior")))


hidden(
         div(id = "finalizar", actionButton("finalizar", "Finalizar")))




div(id = "proximo", actionButton("proximo", "Próximo"))

```

```{r}
#actionButton("proximo", "Próximo")


observeEvent(input$proximo, {
  
  set_next_state(input$state, "P")
  

})


observeEvent(input$anterior, {
  
  
  set_next_state(input$state, "A")
  

})


```



Column {data-width=200}
-----------------------------------------------------------------------

### Instruções


```{r}
shiny::renderUI({
  

  instrucoes_trabalho<- 
    instrucoes%>%
    filter(estado==input$state)%>%
  select(instrucoes)
    


    HTML(
        
        kable(instrucoes_trabalho, col.names = "")
    )
})

```


### Sobre a sua escolha

```{r}
shiny::renderUI({
  

  
  glossario_trabalho<- 
    glossario_siconfi%>%
    filter(topico==input$topico) %>%
    select(explicacao)
    


    HTML(
        
        kable(glossario_trabalho, col.names = "")
    )
})



```


Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Gráfico com dados da seleção

```{r}


renderPlot({
  
  
  
  id_topico<-
    (glossario_siconfi%>%
       filter(topico==input$topico)%>%
       select(id))$id[1]
  
  id_opcao<- list(topico = id_topico, ano= input$ano, fase = input$fase)
  
  
  
  
  
  graph<-generate_graph(id_opcao)
  
  graph
  
  
})


```

### Dados brutos da seleção

```{r}
library(DT)


renderDataTable({

  id_topico<<-
    (glossario_siconfi%>%
       filter(topico==input$topico)%>%
       select(id))$id[1]
  
  id_opcao<- list(topico = id_topico, ano= input$ano, fase = input$fase)
  
  raw_data<<- generate_dt(id_opcao)
  
  DT::datatable(
    raw_data,
    rownames = FALSE,
    fillContainer = TRUE,
    selection = c("none"),
    
    extensions = 'Buttons', options = list(
      pageLength = NROW(raw_data),
      dom = 'Bfrtip',
      buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
    )
  )
  
  
})

```

### Script que gera os dados

```{r}
library(DT)


renderDataTable({

  id_topico<<-
    (glossario_siconfi%>%
       filter(topico==input$topico)%>%
       select(id))$id[1]
  
  id_opcao<- list(topico = id_topico, ano= input$ano, fase = input$fase)
  
  script<- generate_script(id_opcao)
  
  # datatable(dados_tabela,rownames = FALSE,fillContainer = TRUE, options= list(
  #     initComplete = JS("function(settings, json) {$(this.api().table().header()).css({'font-size' : '10px'});}"),
  #     ordering=FALSE,paging=FALSE,searching= FALSE, info = FALSE, columnDefs =  list(list(className = 'dt-left', targets = 0:0), list(className = 'dt-right', targets = 1:3))),filter = "none", selection = "none")%>% formatStyle(1:4,fontSize = '70%')
  
  
  DT::datatable(
    script,
    class = "",
    rownames = FALSE,
    fillContainer = TRUE,
    selection = c("none"),
    extensions = 'Buttons', options = list(
       ordering=FALSE,
       paging=FALSE,
       searching= FALSE,
       info = FALSE,
       pageLength = NROW(script),
       dom = 'Bfrtip',
       buttons = c('copy')
    )
  )%>%
    formatStyle( columns = "script",backgroundColor = '#f5f5f5')
  
  
})



```

